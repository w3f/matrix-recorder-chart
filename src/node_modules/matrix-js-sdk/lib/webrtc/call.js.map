{"version":3,"sources":["../../src/webrtc/call.js"],"names":["utils","require","EventEmitter","DEBUG","MatrixCall","opts","roomId","client","webRtc","forceTURN","URL","turnServers","length","push","urls","FALLBACK_STUN_SERVER","forEach","server","checkObjectHasKeys","callId","Date","getTime","Math","random","state","didConnect","candidateSendQueue","candidateSendTries","mediaPromises","Object","create","screenSharingStream","CALL_TIMEOUT_MS","ERR_LOCAL_OFFER_FAILED","ERR_NO_USER_MEDIA","inherits","prototype","placeVoiceCall","debuglog","checkForErrorListener","_placeCallWithConstraints","_getUserMediaVideoContraints","type","placeVideoCall","remoteVideoElement","localVideoElement","_tryPlayRemoteStream","placeScreenSharingCall","screenConstraints","_getScreenSharingConstraints","self","getUserMedia","stream","audioConstraints","err","emit","callError","playElement","element","queueId","console","log","then","play","pauseElement","pause","assignElement","srcObject","getLocalVideoElement","getRemoteVideoElement","getRemoteAudioElement","remoteAudioElement","setLocalVideoElement","localAVStream","autoplay","muted","setTimeout","vel","setRemoteVideoElement","setRemoteAudioElement","_tryPlayRemoteAudioStream","_initWithInvite","event","msg","getContent","peerConn","_createPeerConnection","setRemoteDescription","RtcSessionDescription","offer","hookCallback","_onSetRemoteDescriptionSuccess","_onSetRemoteDescriptionError","setState","direction","sdp","indexOf","getAge","hangupParty","stopAllMedia","signalingState","close","lifetime","_initWithHangup","answer","waitForLocalAVStream","_maybeGotUserMediaForAnswer","_replacedBy","newCall","successor","hangup","reason","suppressEvent","terminate","content","version","call_id","sendEvent","setLocalVideoMuted","setTracksEnabled","getVideoTracks","isLocalVideoMuted","isTracksEnabled","setMicrophoneMuted","getAudioTracks","isMicrophoneMuted","_maybeGotUserMediaForInvite","error","constraints","MediaStream","videoEl","addTrack","addStream","name","_getUserMediaFailed","createOffer","_gotLocalOffer","_getLocalOfferFailed","localVidEl","createAnswer","description","setLocalDescription","localDescription","_gotLocalIceCandidate","candidate","sdpMid","c","sdpMLineIndex","sendCandidate","_gotRemoteIceCandidate","cand","addIceCandidate","RtcIceCandidate","e","_receivedAnswer","_onIceConnectionStateChanged","iceConnectionState","_onSignallingStateChanged","_onAddStream","id","s","remoteAVStream","remoteAStream","forAllTracksOnStream","t","onstarted","_onRemoteStreamTrackStarted","oninactive","undefined","_onRemoteStreamEnded","onended","_onRemoteStreamStarted","_onHangupReceived","_onAnsweredElsewhere","tracks","enabled","i","oldState","eventType","catch","_sendCandidateQueue","hangupReason","shouldEmit","stop","player","isOpenWebRTC","ael","listeners","Error","code","arguments","cands","candidates","delayMs","pow","callList","config","servers","vendor","j","url","username","credential","pc","RtcPeerConnection","iceTransportPolicy","iceServers","oniceconnectionstatechange","onsignalingstatechange","onicecandidate","onaddstream","call","screen","global","video","mediaSource","mandatory","chromeMediaSource","chromeMediaSourceId","now","maxWidth","width","maxHeight","height","minFrameRate","maxFrameRate","callType","isWebkit","window","navigator","webkitGetUserMedia","audio","deviceId","audioInput","exact","videoInput","ideal","fn","apply","forAllVideoTracksOnStream","f","forAllAudioTracksOnStream","module","exports","setAudioInput","setVideoInput","createNewMatrixCall","options","w","doc","document","scripts","getElementById","src","mozGetUserMedia","RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCSessionDescription","webkitRTCSessionDescription","mozRTCSessionDescription","RTCIceCandidate","webkitRTCIceCandidate","mozRTCIceCandidate","getTurnServers"],"mappings":"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","file":"call.js","sourcesContent":["/*\nCopyright 2015, 2016 OpenMarket Ltd\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\"use strict\";\n/**\n * This is an internal module. See {@link createNewMatrixCall} for the public API.\n * @module webrtc/call\n */\nconst utils = require(\"../utils\");\nconst EventEmitter = require(\"events\").EventEmitter;\nconst DEBUG = true;  // set true to enable console logging.\n\n// events: hangup, error(err), replaced(call), state(state, oldState)\n\n/**\n * Fires when the MatrixCall encounters an error when sending a Matrix event.\n * <p>\n * This is required to allow errors, which occur during sending of events, to bubble up.\n * (This is because call.js does a hangup when it encounters a normal `error`, which in\n * turn could lead to an UnknownDeviceError.)\n * <p>\n * To deal with an UnknownDeviceError when trying to send events, the application should let\n * users know that there are new devices in the encrypted room (into which the event was\n * sent) and give the user the options to resend unsent events or cancel them. Resending\n * is done using {@link module:client~MatrixClient#resendEvent} and cancelling can be done by using\n * {@link module:client~MatrixClient#cancelPendingEvent}.\n * <p>\n * MatrixCall will not do anything in response to an error that causes `send_event_error`\n * to be emitted with the exception of sending `m.call.candidates`, which is retried upon\n * failure when ICE candidates are being sent. This happens during call setup.\n *\n * @event module:webrtc/call~MatrixCall#\"send_event_error\"\n * @param {Error} err The error caught from calling client.sendEvent in call.js.\n * @example\n * matrixCall.on(\"send_event_error\", function(err){\n *   console.error(err);\n * });\n */\n\n/**\n * Fires whenever an error occurs when call.js encounters an issue with setting up the call.\n * <p>\n * The error given will have a code equal to either `MatrixCall.ERR_LOCAL_OFFER_FAILED` or\n * `MatrixCall.ERR_NO_USER_MEDIA`. `ERR_LOCAL_OFFER_FAILED` is emitted when the local client\n * fails to create an offer. `ERR_NO_USER_MEDIA` is emitted when the user has denied access\n * to their audio/video hardware.\n *\n * @event module:webrtc/call~MatrixCall#\"error\"\n * @param {Error} err The error raised by MatrixCall.\n * @example\n * matrixCall.on(\"error\", function(err){\n *   console.error(err.code, err);\n * });\n */\n\n/**\n * Construct a new Matrix Call.\n * @constructor\n * @param {Object} opts Config options.\n * @param {string} opts.roomId The room ID for this call.\n * @param {Object} opts.webRtc The WebRTC globals from the browser.\n * @param {boolean} opts.forceTURN whether relay through TURN should be forced.\n * @param {Object} opts.URL The URL global.\n * @param {Array<Object>} opts.turnServers Optional. A list of TURN servers.\n * @param {MatrixClient} opts.client The Matrix Client instance to send events to.\n */\nfunction MatrixCall(opts) {\n    this.roomId = opts.roomId;\n    this.client = opts.client;\n    this.webRtc = opts.webRtc;\n    this.forceTURN = opts.forceTURN;\n    this.URL = opts.URL;\n    // Array of Objects with urls, username, credential keys\n    this.turnServers = opts.turnServers || [];\n    if (this.turnServers.length === 0) {\n        this.turnServers.push({\n            urls: [MatrixCall.FALLBACK_STUN_SERVER],\n        });\n    }\n    utils.forEach(this.turnServers, function(server) {\n        utils.checkObjectHasKeys(server, [\"urls\"]);\n    });\n\n    this.callId = \"c\" + new Date().getTime() + Math.random();\n    this.state = 'fledgling';\n    this.didConnect = false;\n\n    // A queue for candidates waiting to go out.\n    // We try to amalgamate candidates into a single candidate message where\n    // possible\n    this.candidateSendQueue = [];\n    this.candidateSendTries = 0;\n\n    // Lookup from opaque queue ID to a promise for media element operations that\n    // need to be serialised into a given queue.  Store this per-MatrixCall on the\n    // assumption that multiple matrix calls will never compete for control of the\n    // same DOM elements.\n    this.mediaPromises = Object.create(null);\n\n    this.screenSharingStream = null;\n}\n/** The length of time a call can be ringing for. */\nMatrixCall.CALL_TIMEOUT_MS = 60000;\n/** The fallback server to use for STUN. */\nMatrixCall.FALLBACK_STUN_SERVER = 'stun:stun.l.google.com:19302';\n/** An error code when the local client failed to create an offer. */\nMatrixCall.ERR_LOCAL_OFFER_FAILED = \"local_offer_failed\";\n/**\n * An error code when there is no local mic/camera to use. This may be because\n * the hardware isn't plugged in, or the user has explicitly denied access.\n */\nMatrixCall.ERR_NO_USER_MEDIA = \"no_user_media\";\n\nutils.inherits(MatrixCall, EventEmitter);\n\n/**\n * Place a voice call to this room.\n * @throws If you have not specified a listener for 'error' events.\n */\nMatrixCall.prototype.placeVoiceCall = function() {\n    debuglog(\"placeVoiceCall\");\n    checkForErrorListener(this);\n    _placeCallWithConstraints(this, _getUserMediaVideoContraints('voice'));\n    this.type = 'voice';\n};\n\n/**\n * Place a video call to this room.\n * @param {Element} remoteVideoElement a <code>&lt;video&gt;</code> DOM element\n * to render video to.\n * @param {Element} localVideoElement a <code>&lt;video&gt;</code> DOM element\n * to render the local camera preview.\n * @throws If you have not specified a listener for 'error' events.\n */\nMatrixCall.prototype.placeVideoCall = function(remoteVideoElement, localVideoElement) {\n    debuglog(\"placeVideoCall\");\n    checkForErrorListener(this);\n    this.localVideoElement = localVideoElement;\n    this.remoteVideoElement = remoteVideoElement;\n    _placeCallWithConstraints(this, _getUserMediaVideoContraints('video'));\n    this.type = 'video';\n    _tryPlayRemoteStream(this);\n};\n\n/**\n * Place a screen-sharing call to this room. This includes audio.\n * <b>This method is EXPERIMENTAL and subject to change without warning. It\n * only works in Google Chrome and Firefox >= 44.</b>\n * @param {Element} remoteVideoElement a <code>&lt;video&gt;</code> DOM element\n * to render video to.\n * @param {Element} localVideoElement a <code>&lt;video&gt;</code> DOM element\n * to render the local camera preview.\n * @throws If you have not specified a listener for 'error' events.\n */\nMatrixCall.prototype.placeScreenSharingCall =\n    function(remoteVideoElement, localVideoElement) {\n    debuglog(\"placeScreenSharingCall\");\n    checkForErrorListener(this);\n    const screenConstraints = _getScreenSharingConstraints(this);\n    if (!screenConstraints) {\n        return;\n    }\n    this.localVideoElement = localVideoElement;\n    this.remoteVideoElement = remoteVideoElement;\n    const self = this;\n    this.webRtc.getUserMedia(screenConstraints, function(stream) {\n        self.screenSharingStream = stream;\n        debuglog(\"Got screen stream, requesting audio stream...\");\n        const audioConstraints = _getUserMediaVideoContraints('voice');\n        _placeCallWithConstraints(self, audioConstraints);\n    }, function(err) {\n        self.emit(\"error\",\n            callError(\n                MatrixCall.ERR_NO_USER_MEDIA,\n                \"Failed to get screen-sharing stream: \" + err,\n            ),\n        );\n    });\n    this.type = 'video';\n    _tryPlayRemoteStream(this);\n};\n\n/**\n * Play the given HTMLMediaElement, serialising the operation into a chain\n * of promises to avoid racing access to the element\n * @param {Element} element HTMLMediaElement element to play\n * @param {string} queueId Arbitrary ID to track the chain of promises to be used\n */\nMatrixCall.prototype.playElement = function(element, queueId) {\n    console.log(\"queuing play on \" + queueId + \" and element \" + element);\n    // XXX: FIXME: Does this leak elements, given the old promises\n    // may hang around and retain a reference to them?\n    if (this.mediaPromises[queueId]) {\n        // XXX: these promises can fail (e.g. by <video/> being unmounted whilst\n        // pending receiving media to play - e.g. whilst switching between\n        // rooms before answering an inbound call), and throw unhandled exceptions.\n        // However, we should soldier on as best we can even if they fail, given\n        // these failures may be non-fatal (as in the case of unmounts)\n        this.mediaPromises[queueId] =\n            this.mediaPromises[queueId].then(function() {\n                console.log(\"previous promise completed for \" + queueId);\n                return element.play();\n            }, function() {\n                console.log(\"previous promise failed for \" + queueId);\n                return element.play();\n            });\n    } else {\n        this.mediaPromises[queueId] = element.play();\n    }\n};\n\n/**\n * Pause the given HTMLMediaElement, serialising the operation into a chain\n * of promises to avoid racing access to the element\n * @param {Element} element HTMLMediaElement element to pause\n * @param {string} queueId Arbitrary ID to track the chain of promises to be used\n */\nMatrixCall.prototype.pauseElement = function(element, queueId) {\n    console.log(\"queuing pause on \" + queueId + \" and element \" + element);\n    if (this.mediaPromises[queueId]) {\n        this.mediaPromises[queueId] =\n            this.mediaPromises[queueId].then(function() {\n                console.log(\"previous promise completed for \" + queueId);\n                return element.pause();\n            }, function() {\n                console.log(\"previous promise failed for \" + queueId);\n                return element.pause();\n            });\n    } else {\n        // pause doesn't actually return a promise, but do this for symmetry\n        // and just in case it does in future.\n        this.mediaPromises[queueId] = element.pause();\n    }\n};\n\n/**\n * Assign the given HTMLMediaElement by setting the .src attribute on it,\n * serialising the operation into a chain of promises to avoid racing access\n * to the element\n * @param {Element} element HTMLMediaElement element to pause\n * @param {MediaStream} srcObject the srcObject attribute value to assign to the element\n * @param {string} queueId Arbitrary ID to track the chain of promises to be used\n */\nMatrixCall.prototype.assignElement = function(element, srcObject, queueId) {\n    console.log(\"queuing assign on \" + queueId + \" element \" + element + \" for \" +\n        srcObject);\n    if (this.mediaPromises[queueId]) {\n        this.mediaPromises[queueId] =\n            this.mediaPromises[queueId].then(function() {\n                console.log(\"previous promise completed for \" + queueId);\n                element.srcObject = srcObject;\n            }, function() {\n                console.log(\"previous promise failed for \" + queueId);\n                element.srcObject = srcObject;\n            });\n    } else {\n        element.srcObject = srcObject;\n    }\n};\n\n/**\n * Retrieve the local <code>&lt;video&gt;</code> DOM element.\n * @return {Element} The dom element\n */\nMatrixCall.prototype.getLocalVideoElement = function() {\n    return this.localVideoElement;\n};\n\n/**\n * Retrieve the remote <code>&lt;video&gt;</code> DOM element\n * used for playing back video capable streams.\n * @return {Element} The dom element\n */\nMatrixCall.prototype.getRemoteVideoElement = function() {\n    return this.remoteVideoElement;\n};\n\n/**\n * Retrieve the remote <code>&lt;audio&gt;</code> DOM element\n * used for playing back audio only streams.\n * @return {Element} The dom element\n */\nMatrixCall.prototype.getRemoteAudioElement = function() {\n    return this.remoteAudioElement;\n};\n\n/**\n * Set the local <code>&lt;video&gt;</code> DOM element. If this call is active,\n * video will be rendered to it immediately.\n * @param {Element} element The <code>&lt;video&gt;</code> DOM element.\n */\nMatrixCall.prototype.setLocalVideoElement = function(element) {\n    this.localVideoElement = element;\n\n    if (element && this.localAVStream && this.type === 'video') {\n        element.autoplay = true;\n        this.assignElement(element, this.localAVStream, \"localVideo\");\n        element.muted = true;\n        const self = this;\n        setTimeout(function() {\n            const vel = self.getLocalVideoElement();\n            if (vel.play) {\n                self.playElement(vel, \"localVideo\");\n            }\n        }, 0);\n    }\n};\n\n/**\n * Set the remote <code>&lt;video&gt;</code> DOM element. If this call is active,\n * the first received video-capable stream will be rendered to it immediately.\n * @param {Element} element The <code>&lt;video&gt;</code> DOM element.\n */\nMatrixCall.prototype.setRemoteVideoElement = function(element) {\n    this.remoteVideoElement = element;\n    _tryPlayRemoteStream(this);\n};\n\n/**\n * Set the remote <code>&lt;audio&gt;</code> DOM element. If this call is active,\n * the first received audio-only stream will be rendered to it immediately.\n * The audio will *not* be rendered from the remoteVideoElement.\n * @param {Element} element The <code>&lt;video&gt;</code> DOM element.\n */\nMatrixCall.prototype.setRemoteAudioElement = function(element) {\n    this.remoteVideoElement.muted = true;\n    this.remoteAudioElement = element;\n    this.remoteAudioElement.muted = false;\n    _tryPlayRemoteAudioStream(this);\n};\n\n/**\n * Configure this call from an invite event. Used by MatrixClient.\n * @protected\n * @param {MatrixEvent} event The m.call.invite event\n */\nMatrixCall.prototype._initWithInvite = function(event) {\n    this.msg = event.getContent();\n    this.peerConn = _createPeerConnection(this);\n    const self = this;\n    if (this.peerConn) {\n        this.peerConn.setRemoteDescription(\n            new this.webRtc.RtcSessionDescription(this.msg.offer),\n            hookCallback(self, self._onSetRemoteDescriptionSuccess),\n            hookCallback(self, self._onSetRemoteDescriptionError),\n        );\n    }\n    setState(this, 'ringing');\n    this.direction = 'inbound';\n\n    // firefox and OpenWebRTC's RTCPeerConnection doesn't add streams until it\n    // starts getting media on them so we need to figure out whether a video\n    // channel has been offered by ourselves.\n    if (\n        this.msg.offer &&\n        this.msg.offer.sdp &&\n        this.msg.offer.sdp.indexOf('m=video') > -1\n    ) {\n        this.type = 'video';\n    } else {\n        this.type = 'voice';\n    }\n\n    if (event.getAge()) {\n        setTimeout(function() {\n            if (self.state == 'ringing') {\n                debuglog(\"Call invite has expired. Hanging up.\");\n                self.hangupParty = 'remote'; // effectively\n                setState(self, 'ended');\n                stopAllMedia(self);\n                if (self.peerConn.signalingState != 'closed') {\n                    self.peerConn.close();\n                }\n                self.emit(\"hangup\", self);\n            }\n        }, this.msg.lifetime - event.getAge());\n    }\n};\n\n/**\n * Configure this call from a hangup event. Used by MatrixClient.\n * @protected\n * @param {MatrixEvent} event The m.call.hangup event\n */\nMatrixCall.prototype._initWithHangup = function(event) {\n    // perverse as it may seem, sometimes we want to instantiate a call with a\n    // hangup message (because when getting the state of the room on load, events\n    // come in reverse order and we want to remember that a call has been hung up)\n    this.msg = event.getContent();\n    setState(this, 'ended');\n};\n\n/**\n * Answer a call.\n */\nMatrixCall.prototype.answer = function() {\n    debuglog(\"Answering call %s of type %s\", this.callId, this.type);\n    const self = this;\n\n    if (!this.localAVStream && !this.waitForLocalAVStream) {\n        this.webRtc.getUserMedia(\n            _getUserMediaVideoContraints(this.type),\n            hookCallback(self, self._maybeGotUserMediaForAnswer),\n            hookCallback(self, self._maybeGotUserMediaForAnswer),\n        );\n        setState(this, 'wait_local_media');\n    } else if (this.localAVStream) {\n        this._maybeGotUserMediaForAnswer(this.localAVStream);\n    } else if (this.waitForLocalAVStream) {\n        setState(this, 'wait_local_media');\n    }\n};\n\n/**\n * Replace this call with a new call, e.g. for glare resolution. Used by\n * MatrixClient.\n * @protected\n * @param {MatrixCall} newCall The new call.\n */\nMatrixCall.prototype._replacedBy = function(newCall) {\n    debuglog(this.callId + \" being replaced by \" + newCall.callId);\n    if (this.state == 'wait_local_media') {\n        debuglog(\"Telling new call to wait for local media\");\n        newCall.waitForLocalAVStream = true;\n    } else if (this.state == 'create_offer') {\n        debuglog(\"Handing local stream to new call\");\n        newCall._maybeGotUserMediaForAnswer(this.localAVStream);\n        delete(this.localAVStream);\n    } else if (this.state == 'invite_sent') {\n        debuglog(\"Handing local stream to new call\");\n        newCall._maybeGotUserMediaForAnswer(this.localAVStream);\n        delete(this.localAVStream);\n    }\n    newCall.localVideoElement = this.localVideoElement;\n    newCall.remoteVideoElement = this.remoteVideoElement;\n    newCall.remoteAudioElement = this.remoteAudioElement;\n    this.successor = newCall;\n    this.emit(\"replaced\", newCall);\n    this.hangup(true);\n};\n\n/**\n * Hangup a call.\n * @param {string} reason The reason why the call is being hung up.\n * @param {boolean} suppressEvent True to suppress emitting an event.\n */\nMatrixCall.prototype.hangup = function(reason, suppressEvent) {\n    debuglog(\"Ending call \" + this.callId);\n    terminate(this, \"local\", reason, !suppressEvent);\n    const content = {\n        version: 0,\n        call_id: this.callId,\n        reason: reason,\n    };\n    sendEvent(this, 'm.call.hangup', content);\n};\n\n/**\n * Set whether the local video preview should be muted or not.\n * @param {boolean} muted True to mute the local video.\n */\nMatrixCall.prototype.setLocalVideoMuted = function(muted) {\n    if (!this.localAVStream) {\n        return;\n    }\n    setTracksEnabled(this.localAVStream.getVideoTracks(), !muted);\n};\n\n/**\n * Check if local video is muted.\n *\n * If there are multiple video tracks, <i>all</i> of the tracks need to be muted\n * for this to return true. This means if there are no video tracks, this will\n * return true.\n * @return {Boolean} True if the local preview video is muted, else false\n * (including if the call is not set up yet).\n */\nMatrixCall.prototype.isLocalVideoMuted = function() {\n    if (!this.localAVStream) {\n        return false;\n    }\n    return !isTracksEnabled(this.localAVStream.getVideoTracks());\n};\n\n/**\n * Set whether the microphone should be muted or not.\n * @param {boolean} muted True to mute the mic.\n */\nMatrixCall.prototype.setMicrophoneMuted = function(muted) {\n    if (!this.localAVStream) {\n        return;\n    }\n    setTracksEnabled(this.localAVStream.getAudioTracks(), !muted);\n};\n\n/**\n * Check if the microphone is muted.\n *\n * If there are multiple audio tracks, <i>all</i> of the tracks need to be muted\n * for this to return true. This means if there are no audio tracks, this will\n * return true.\n * @return {Boolean} True if the mic is muted, else false (including if the call\n * is not set up yet).\n */\nMatrixCall.prototype.isMicrophoneMuted = function() {\n    if (!this.localAVStream) {\n        return false;\n    }\n    return !isTracksEnabled(this.localAVStream.getAudioTracks());\n};\n\n/**\n * Internal\n * @private\n * @param {Object} stream\n */\nMatrixCall.prototype._maybeGotUserMediaForInvite = function(stream) {\n    if (this.successor) {\n        this.successor._maybeGotUserMediaForAnswer(stream);\n        return;\n    }\n    if (this.state == 'ended') {\n        return;\n    }\n    debuglog(\"_maybeGotUserMediaForInvite -> \" + this.type);\n    const self = this;\n\n    const error = stream;\n    const constraints = {\n        'mandatory': {\n            'OfferToReceiveAudio': true,\n            'OfferToReceiveVideo': self.type === 'video',\n        },\n    };\n    if (stream instanceof MediaStream) {\n        const videoEl = this.getLocalVideoElement();\n\n        if (videoEl && this.type == 'video') {\n            videoEl.autoplay = true;\n            if (this.screenSharingStream) {\n                debuglog(\"Setting screen sharing stream to the local video\" +\n                    \" element\");\n                this.assignElement(videoEl, this.screenSharingStream, \"localVideo\");\n            } else {\n                this.assignElement(videoEl, stream, \"localVideo\");\n            }\n            videoEl.muted = true;\n            setTimeout(function() {\n                const vel = self.getLocalVideoElement();\n                if (vel.play) {\n                    self.playElement(vel, \"localVideo\");\n                }\n            }, 0);\n        }\n\n        if (this.screenSharingStream) {\n            this.screenSharingStream.addTrack(stream.getAudioTracks()[0]);\n            stream = this.screenSharingStream;\n        }\n\n        this.localAVStream = stream;\n        // why do we enable audio (and only audio) tracks here? -- matthew\n        setTracksEnabled(stream.getAudioTracks(), true);\n        this.peerConn = _createPeerConnection(this);\n        this.peerConn.addStream(stream);\n    } else if (error.name === 'PermissionDeniedError') {\n        debuglog('User denied access to camera/microphone.' +\n            ' Or possibly you are using an insecure domain. Receiving only.');\n        this.peerConn = _createPeerConnection(this);\n    } else {\n        debuglog('Failed to getUserMedia.');\n        this._getUserMediaFailed(error);\n        return;\n    }\n\n    this.peerConn.createOffer(\n        hookCallback(self, self._gotLocalOffer),\n        hookCallback(self, self._getLocalOfferFailed),\n        constraints,\n    );\n    setState(self, 'create_offer');\n};\n\n/**\n * Internal\n * @private\n * @param {Object} stream\n */\nMatrixCall.prototype._maybeGotUserMediaForAnswer = function(stream) {\n    const self = this;\n    if (self.state == 'ended') {\n        return;\n    }\n\n    const error = stream;\n    if (stream instanceof MediaStream) {\n        const localVidEl = self.getLocalVideoElement();\n\n        if (localVidEl && self.type == 'video') {\n            localVidEl.autoplay = true;\n            this.assignElement(localVidEl, stream, \"localVideo\");\n            localVidEl.muted = true;\n            setTimeout(function() {\n                const vel = self.getLocalVideoElement();\n                if (vel.play) {\n                    self.playElement(vel, \"localVideo\");\n                }\n            }, 0);\n        }\n\n        self.localAVStream = stream;\n        setTracksEnabled(stream.getAudioTracks(), true);\n        self.peerConn.addStream(stream);\n    } else if (error.name === 'PermissionDeniedError') {\n        debuglog('User denied access to camera/microphone.' +\n            ' Or possibly you are using an insecure domain. Receiving only.');\n    } else {\n        debuglog('Failed to getUserMedia.');\n        this._getUserMediaFailed(error);\n        return;\n    }\n\n    const constraints = {\n        'mandatory': {\n            'OfferToReceiveAudio': true,\n            'OfferToReceiveVideo': self.type === 'video',\n        },\n    };\n    self.peerConn.createAnswer(function(description) {\n        debuglog(\"Created answer: \" + description);\n        self.peerConn.setLocalDescription(description, function() {\n            const content = {\n                version: 0,\n                call_id: self.callId,\n                answer: {\n                    sdp: self.peerConn.localDescription.sdp,\n                    type: self.peerConn.localDescription.type,\n                },\n            };\n            sendEvent(self, 'm.call.answer', content);\n            setState(self, 'connecting');\n        }, function() {\n            debuglog(\"Error setting local description!\");\n        }, constraints);\n    }, function(err) {\n        debuglog(\"Failed to create answer: \" + err);\n    });\n    setState(self, 'create_answer');\n};\n\n/**\n * Internal\n * @private\n * @param {Object} event\n */\nMatrixCall.prototype._gotLocalIceCandidate = function(event) {\n    if (event.candidate) {\n        debuglog(\n            \"Got local ICE \" + event.candidate.sdpMid + \" candidate: \" +\n            event.candidate.candidate,\n        );\n        // As with the offer, note we need to make a copy of this object, not\n        // pass the original: that broke in Chrome ~m43.\n        const c = {\n            candidate: event.candidate.candidate,\n            sdpMid: event.candidate.sdpMid,\n            sdpMLineIndex: event.candidate.sdpMLineIndex,\n        };\n        sendCandidate(this, c);\n    }\n};\n\n/**\n * Used by MatrixClient.\n * @protected\n * @param {Object} cand\n */\nMatrixCall.prototype._gotRemoteIceCandidate = function(cand) {\n    if (this.state == 'ended') {\n        //debuglog(\"Ignoring remote ICE candidate because call has ended\");\n        return;\n    }\n    debuglog(\"Got remote ICE \" + cand.sdpMid + \" candidate: \" + cand.candidate);\n    this.peerConn.addIceCandidate(\n        new this.webRtc.RtcIceCandidate(cand),\n        function() {},\n        function(e) {},\n    );\n};\n\n/**\n * Used by MatrixClient.\n * @protected\n * @param {Object} msg\n */\nMatrixCall.prototype._receivedAnswer = function(msg) {\n    if (this.state == 'ended') {\n        return;\n    }\n\n    const self = this;\n    this.peerConn.setRemoteDescription(\n        new this.webRtc.RtcSessionDescription(msg.answer),\n        hookCallback(self, self._onSetRemoteDescriptionSuccess),\n        hookCallback(self, self._onSetRemoteDescriptionError),\n    );\n    setState(self, 'connecting');\n};\n\n/**\n * Internal\n * @private\n * @param {Object} description\n */\nMatrixCall.prototype._gotLocalOffer = function(description) {\n    const self = this;\n    debuglog(\"Created offer: \" + description);\n\n    if (self.state == 'ended') {\n        debuglog(\"Ignoring newly created offer on call ID \" + self.callId +\n            \" because the call has ended\");\n        return;\n    }\n\n    self.peerConn.setLocalDescription(description, function() {\n        const content = {\n            version: 0,\n            call_id: self.callId,\n            // OpenWebRTC appears to add extra stuff (like the DTLS fingerprint)\n            // to the description when setting it on the peerconnection.\n            // According to the spec it should only add ICE\n            // candidates. Any ICE candidates that have already been generated\n            // at this point will probably be sent both in the offer and separately.\n            // Also, note that we have to make a new object here, copying the\n            // type and sdp properties.\n            // Passing the RTCSessionDescription object as-is doesn't work in\n            // Chrome (as of about m43).\n            offer: {\n                sdp: self.peerConn.localDescription.sdp,\n                type: self.peerConn.localDescription.type,\n            },\n            lifetime: MatrixCall.CALL_TIMEOUT_MS,\n        };\n        sendEvent(self, 'm.call.invite', content);\n\n        setTimeout(function() {\n            if (self.state == 'invite_sent') {\n                self.hangup('invite_timeout');\n            }\n        }, MatrixCall.CALL_TIMEOUT_MS);\n        setState(self, 'invite_sent');\n    }, function() {\n        debuglog(\"Error setting local description!\");\n    });\n};\n\n/**\n * Internal\n * @private\n * @param {Object} error\n */\nMatrixCall.prototype._getLocalOfferFailed = function(error) {\n    this.emit(\n        \"error\",\n        callError(MatrixCall.ERR_LOCAL_OFFER_FAILED, \"Failed to start audio for call!\"),\n    );\n};\n\n/**\n * Internal\n * @private\n * @param {Object} error\n */\nMatrixCall.prototype._getUserMediaFailed = function(error) {\n    this.emit(\n        \"error\",\n        callError(\n            MatrixCall.ERR_NO_USER_MEDIA,\n            \"Couldn't start capturing media! Is your microphone set up and \" +\n            \"does this app have permission?\",\n        ),\n    );\n    this.hangup(\"user_media_failed\");\n};\n\n/**\n * Internal\n * @private\n */\nMatrixCall.prototype._onIceConnectionStateChanged = function() {\n    if (this.state == 'ended') {\n        return; // because ICE can still complete as we're ending the call\n    }\n    debuglog(\n        \"Ice connection state changed to: \" + this.peerConn.iceConnectionState,\n    );\n    // ideally we'd consider the call to be connected when we get media but\n    // chrome doesn't implement any of the 'onstarted' events yet\n    if (this.peerConn.iceConnectionState == 'completed' ||\n            this.peerConn.iceConnectionState == 'connected') {\n        setState(this, 'connected');\n        this.didConnect = true;\n    } else if (this.peerConn.iceConnectionState == 'failed') {\n        this.hangup('ice_failed');\n    }\n};\n\n/**\n * Internal\n * @private\n */\nMatrixCall.prototype._onSignallingStateChanged = function() {\n    debuglog(\n        \"call \" + this.callId + \": Signalling state changed to: \" +\n        this.peerConn.signalingState,\n    );\n};\n\n/**\n * Internal\n * @private\n */\nMatrixCall.prototype._onSetRemoteDescriptionSuccess = function() {\n    debuglog(\"Set remote description\");\n};\n\n/**\n * Internal\n * @private\n * @param {Object} e\n */\nMatrixCall.prototype._onSetRemoteDescriptionError = function(e) {\n    debuglog(\"Failed to set remote description\" + e);\n};\n\n/**\n * Internal\n * @private\n * @param {Object} event\n */\nMatrixCall.prototype._onAddStream = function(event) {\n    debuglog(\"Stream id \" + event.stream.id + \" added\");\n\n    const s = event.stream;\n\n    if (s.getVideoTracks().length > 0) {\n        this.type = 'video';\n        this.remoteAVStream = s;\n        this.remoteAStream = s;\n    } else {\n        this.type = 'voice';\n        this.remoteAStream = s;\n    }\n\n    const self = this;\n    forAllTracksOnStream(s, function(t) {\n        debuglog(\"Track id \" + t.id + \" added\");\n        // not currently implemented in chrome\n        t.onstarted = hookCallback(self, self._onRemoteStreamTrackStarted);\n    });\n\n    if (event.stream.oninactive !== undefined) {\n        event.stream.oninactive = hookCallback(self, self._onRemoteStreamEnded);\n    } else {\n        // onended is deprecated from Chrome 54\n        event.stream.onended = hookCallback(self, self._onRemoteStreamEnded);\n    }\n\n    // not currently implemented in chrome\n    event.stream.onstarted = hookCallback(self, self._onRemoteStreamStarted);\n\n    if (this.type === 'video') {\n        _tryPlayRemoteStream(this);\n        _tryPlayRemoteAudioStream(this);\n    } else {\n        _tryPlayRemoteAudioStream(this);\n    }\n};\n\n/**\n * Internal\n * @private\n * @param {Object} event\n */\nMatrixCall.prototype._onRemoteStreamStarted = function(event) {\n    setState(this, 'connected');\n};\n\n/**\n * Internal\n * @private\n * @param {Object} event\n */\nMatrixCall.prototype._onRemoteStreamEnded = function(event) {\n    debuglog(\"Remote stream ended\");\n    this.hangupParty = 'remote';\n    setState(this, 'ended');\n    stopAllMedia(this);\n    if (this.peerConn.signalingState != 'closed') {\n        this.peerConn.close();\n    }\n    this.emit(\"hangup\", this);\n};\n\n/**\n * Internal\n * @private\n * @param {Object} event\n */\nMatrixCall.prototype._onRemoteStreamTrackStarted = function(event) {\n    setState(this, 'connected');\n};\n\n/**\n * Used by MatrixClient.\n * @protected\n * @param {Object} msg\n */\nMatrixCall.prototype._onHangupReceived = function(msg) {\n    debuglog(\"Hangup received\");\n    terminate(this, \"remote\", msg.reason, true);\n};\n\n/**\n * Used by MatrixClient.\n * @protected\n * @param {Object} msg\n */\nMatrixCall.prototype._onAnsweredElsewhere = function(msg) {\n    debuglog(\"Answered elsewhere\");\n    terminate(this, \"remote\", \"answered_elsewhere\", true);\n};\n\nconst setTracksEnabled = function(tracks, enabled) {\n    for (let i = 0; i < tracks.length; i++) {\n        tracks[i].enabled = enabled;\n    }\n};\n\nconst isTracksEnabled = function(tracks) {\n    for (let i = 0; i < tracks.length; i++) {\n        if (tracks[i].enabled) {\n            return true; // at least one track is enabled\n        }\n    }\n    return false;\n};\n\nconst setState = function(self, state) {\n    const oldState = self.state;\n    self.state = state;\n    self.emit(\"state\", state, oldState);\n};\n\n/**\n * Internal\n * @param {MatrixCall} self\n * @param {string} eventType\n * @param {Object} content\n * @return {Promise}\n */\nconst sendEvent = function(self, eventType, content) {\n    return self.client.sendEvent(self.roomId, eventType, content).catch(\n        (err) => {\n            self.emit('send_event_error', err);\n        },\n    );\n};\n\nconst sendCandidate = function(self, content) {\n    // Sends candidates with are sent in a special way because we try to amalgamate\n    // them into one message\n    self.candidateSendQueue.push(content);\n    if (self.candidateSendTries === 0) {\n        setTimeout(function() {\n            _sendCandidateQueue(self);\n        }, 100);\n    }\n};\n\nconst terminate = function(self, hangupParty, hangupReason, shouldEmit) {\n    if (self.getRemoteVideoElement()) {\n        if (self.getRemoteVideoElement().pause) {\n            self.pauseElement(self.getRemoteVideoElement(), \"remoteVideo\");\n        }\n        self.assignElement(self.getRemoteVideoElement(), null, \"remoteVideo\");\n    }\n    if (self.getRemoteAudioElement()) {\n        if (self.getRemoteAudioElement().pause) {\n            self.pauseElement(self.getRemoteAudioElement(), \"remoteAudio\");\n        }\n        self.assignElement(self.getRemoteAudioElement(), null, \"remoteAudio\");\n    }\n    if (self.getLocalVideoElement()) {\n        if (self.getLocalVideoElement().pause) {\n            self.pauseElement(self.getLocalVideoElement(), \"localVideo\");\n        }\n        self.assignElement(self.getLocalVideoElement(), null, \"localVideo\");\n    }\n    self.hangupParty = hangupParty;\n    self.hangupReason = hangupReason;\n    setState(self, 'ended');\n    stopAllMedia(self);\n    if (self.peerConn && self.peerConn.signalingState !== 'closed') {\n        self.peerConn.close();\n    }\n    if (shouldEmit) {\n        self.emit(\"hangup\", self);\n    }\n};\n\nconst stopAllMedia = function(self) {\n    debuglog(\"stopAllMedia (stream=%s)\", self.localAVStream);\n    if (self.localAVStream) {\n        forAllTracksOnStream(self.localAVStream, function(t) {\n            if (t.stop) {\n                t.stop();\n            }\n        });\n        // also call stop on the main stream so firefox will stop sharing\n        // the mic\n        if (self.localAVStream.stop) {\n            self.localAVStream.stop();\n        }\n    }\n    if (self.screenSharingStream) {\n        forAllTracksOnStream(self.screenSharingStream, function(t) {\n            if (t.stop) {\n                t.stop();\n            }\n        });\n        if (self.screenSharingStream.stop) {\n            self.screenSharingStream.stop();\n        }\n    }\n    if (self.remoteAVStream) {\n        forAllTracksOnStream(self.remoteAVStream, function(t) {\n            if (t.stop) {\n                t.stop();\n            }\n        });\n    }\n    if (self.remoteAStream) {\n        forAllTracksOnStream(self.remoteAStream, function(t) {\n            if (t.stop) {\n                t.stop();\n            }\n        });\n    }\n};\n\nconst _tryPlayRemoteStream = function(self) {\n    if (self.getRemoteVideoElement() && self.remoteAVStream) {\n        const player = self.getRemoteVideoElement();\n        player.autoplay = true;\n        self.assignElement(player, self.remoteAVStream, \"remoteVideo\");\n        setTimeout(function() {\n            const vel = self.getRemoteVideoElement();\n            if (vel.play) {\n                self.playElement(vel, \"remoteVideo\");\n            }\n            // OpenWebRTC does not support oniceconnectionstatechange yet\n            if (self.webRtc.isOpenWebRTC()) {\n                setState(self, 'connected');\n            }\n        }, 0);\n    }\n};\n\nconst _tryPlayRemoteAudioStream = function(self) {\n    if (self.getRemoteAudioElement() && self.remoteAStream) {\n        const player = self.getRemoteAudioElement();\n        player.autoplay = true;\n        self.assignElement(player, self.remoteAStream, \"remoteAudio\");\n        setTimeout(function() {\n            const ael = self.getRemoteAudioElement();\n            if (ael.play) {\n                self.playElement(ael, \"remoteAudio\");\n            }\n            // OpenWebRTC does not support oniceconnectionstatechange yet\n            if (self.webRtc.isOpenWebRTC()) {\n                setState(self, 'connected');\n            }\n        }, 0);\n    }\n};\n\nconst checkForErrorListener = function(self) {\n    if (self.listeners(\"error\").length === 0) {\n        throw new Error(\n            \"You MUST attach an error listener using call.on('error', function() {})\",\n        );\n    }\n};\n\nconst callError = function(code, msg) {\n    const e = new Error(msg);\n    e.code = code;\n    return e;\n};\n\nconst debuglog = function() {\n    if (DEBUG) {\n        console.log(...arguments);\n    }\n};\n\nconst _sendCandidateQueue = function(self) {\n    if (self.candidateSendQueue.length === 0) {\n        return;\n    }\n\n    const cands = self.candidateSendQueue;\n    self.candidateSendQueue = [];\n    ++self.candidateSendTries;\n    const content = {\n        version: 0,\n        call_id: self.callId,\n        candidates: cands,\n    };\n    debuglog(\"Attempting to send \" + cands.length + \" candidates\");\n    sendEvent(self, 'm.call.candidates', content).then(function() {\n        self.candidateSendTries = 0;\n        _sendCandidateQueue(self);\n    }, function(error) {\n        for (let i = 0; i < cands.length; i++) {\n            self.candidateSendQueue.push(cands[i]);\n        }\n\n        if (self.candidateSendTries > 5) {\n            debuglog(\n                \"Failed to send candidates on attempt %s. Giving up for now.\",\n                self.candidateSendTries,\n            );\n            self.candidateSendTries = 0;\n            return;\n        }\n\n        const delayMs = 500 * Math.pow(2, self.candidateSendTries);\n        ++self.candidateSendTries;\n        debuglog(\"Failed to send candidates. Retrying in \" + delayMs + \"ms\");\n        setTimeout(function() {\n            _sendCandidateQueue(self);\n        }, delayMs);\n    });\n};\n\nconst _placeCallWithConstraints = function(self, constraints) {\n    self.client.callList[self.callId] = self;\n    self.webRtc.getUserMedia(\n        constraints,\n        hookCallback(self, self._maybeGotUserMediaForInvite),\n        hookCallback(self, self._maybeGotUserMediaForInvite),\n    );\n    setState(self, 'wait_local_media');\n    self.direction = 'outbound';\n    self.config = constraints;\n};\n\nconst _createPeerConnection = function(self) {\n    let servers = self.turnServers;\n    if (self.webRtc.vendor === \"mozilla\") {\n        // modify turnServers struct to match what mozilla expects.\n        servers = [];\n        for (let i = 0; i < self.turnServers.length; i++) {\n            for (let j = 0; j < self.turnServers[i].urls.length; j++) {\n                servers.push({\n                    url: self.turnServers[i].urls[j],\n                    username: self.turnServers[i].username,\n                    credential: self.turnServers[i].credential,\n                });\n            }\n        }\n    }\n\n    const pc = new self.webRtc.RtcPeerConnection({\n        iceTransportPolicy: self.forceTURN ? 'relay' : undefined,\n        iceServers: servers,\n    });\n    pc.oniceconnectionstatechange = hookCallback(self, self._onIceConnectionStateChanged);\n    pc.onsignalingstatechange = hookCallback(self, self._onSignallingStateChanged);\n    pc.onicecandidate = hookCallback(self, self._gotLocalIceCandidate);\n    pc.onaddstream = hookCallback(self, self._onAddStream);\n    return pc;\n};\n\nconst _getScreenSharingConstraints = function(call) {\n    const screen = global.screen;\n    if (!screen) {\n        call.emit(\"error\", callError(\n            MatrixCall.ERR_NO_USER_MEDIA,\n            \"Couldn't determine screen sharing constaints.\",\n        ));\n        return;\n    }\n\n    return {\n        video: {\n            mediaSource: 'screen',\n            mandatory: {\n                chromeMediaSource: \"screen\",\n                chromeMediaSourceId: \"\" + Date.now(),\n                maxWidth: screen.width,\n                maxHeight: screen.height,\n                minFrameRate: 1,\n                maxFrameRate: 10,\n            },\n        },\n    };\n};\n\nconst _getUserMediaVideoContraints = function(callType) {\n    const isWebkit = !!global.window.navigator.webkitGetUserMedia;\n\n    switch (callType) {\n        case 'voice':\n            return {\n                audio: {\n                    deviceId: audioInput ? {exact: audioInput} : undefined,\n                }, video: false,\n            };\n        case 'video':\n            return {\n                audio: {\n                    deviceId: audioInput ? {exact: audioInput} : undefined,\n                }, video: {\n                    deviceId: videoInput ? {exact: videoInput} : undefined,\n                    /* We want 640x360.  Chrome will give it only if we ask exactly,\n                       FF refuses entirely if we ask exactly, so have to ask for ideal\n                       instead */\n                    width: isWebkit ? { exact: 640 } : { ideal: 640 },\n                    height: isWebkit ? { exact: 360 } : { ideal: 360 },\n                },\n            };\n    }\n};\n\nconst hookCallback = function(call, fn) {\n    return function() {\n        return fn.apply(call, arguments);\n    };\n};\n\nconst forAllVideoTracksOnStream = function(s, f) {\n    const tracks = s.getVideoTracks();\n    for (let i = 0; i < tracks.length; i++) {\n        f(tracks[i]);\n    }\n};\n\nconst forAllAudioTracksOnStream = function(s, f) {\n    const tracks = s.getAudioTracks();\n    for (let i = 0; i < tracks.length; i++) {\n        f(tracks[i]);\n    }\n};\n\nconst forAllTracksOnStream = function(s, f) {\n    forAllVideoTracksOnStream(s, f);\n    forAllAudioTracksOnStream(s, f);\n};\n\n/** The MatrixCall class. */\nmodule.exports.MatrixCall = MatrixCall;\n\nlet audioInput;\nlet videoInput;\n/**\n * Set an audio input device to use for MatrixCalls\n * @function\n * @param {string=} deviceId the identifier for the device\n * undefined treated as unset\n */\nmodule.exports.setAudioInput = function(deviceId) { audioInput = deviceId; };\n/**\n * Set a video input device to use for MatrixCalls\n * @function\n * @param {string=} deviceId the identifier for the device\n * undefined treated as unset\n */\nmodule.exports.setVideoInput = function(deviceId) { videoInput = deviceId; };\n\n/**\n * Create a new Matrix call for the browser.\n * @param {MatrixClient} client The client instance to use.\n * @param {string} roomId The room the call is in.\n * @param {Object?} options optional options map.\n * @param {boolean} options.forceTURN whether relay through TURN should be forced.\n * @return {MatrixCall} the call or null if the browser doesn't support calling.\n */\nmodule.exports.createNewMatrixCall = function(client, roomId, options) {\n    const w = global.window;\n    const doc = global.document;\n    if (!w || !doc) {\n        return null;\n    }\n    const webRtc = {};\n    webRtc.isOpenWebRTC = function() {\n        const scripts = doc.getElementById(\"script\");\n        if (!scripts || !scripts.length) {\n            return false;\n        }\n        for (let i = 0; i < scripts.length; i++) {\n            if (scripts[i].src.indexOf(\"owr.js\") > -1) {\n                return true;\n            }\n        }\n        return false;\n    };\n    const getUserMedia = (\n        w.navigator.getUserMedia || w.navigator.webkitGetUserMedia ||\n        w.navigator.mozGetUserMedia\n    );\n    if (getUserMedia) {\n        webRtc.getUserMedia = function() {\n            return getUserMedia.apply(w.navigator, arguments);\n        };\n    }\n    webRtc.RtcPeerConnection = (\n        w.RTCPeerConnection || w.webkitRTCPeerConnection || w.mozRTCPeerConnection\n    );\n    webRtc.RtcSessionDescription = (\n        w.RTCSessionDescription || w.webkitRTCSessionDescription ||\n        w.mozRTCSessionDescription\n    );\n    webRtc.RtcIceCandidate = (\n        w.RTCIceCandidate || w.webkitRTCIceCandidate || w.mozRTCIceCandidate\n    );\n    webRtc.vendor = null;\n    if (w.mozRTCPeerConnection) {\n        webRtc.vendor = \"mozilla\";\n    } else if (w.webkitRTCPeerConnection) {\n        webRtc.vendor = \"webkit\";\n    } else if (w.RTCPeerConnection) {\n        webRtc.vendor = \"generic\";\n    }\n    if (!webRtc.RtcIceCandidate || !webRtc.RtcSessionDescription ||\n            !webRtc.RtcPeerConnection || !webRtc.getUserMedia) {\n        return null; // WebRTC is not supported.\n    }\n    const opts = {\n        webRtc: webRtc,\n        client: client,\n        URL: w.URL,\n        roomId: roomId,\n        turnServers: client.getTurnServers(),\n        // call level options\n        forceTURN: options ? options.forceTURN : false,\n    };\n    return new MatrixCall(opts);\n};\n"]}