{"version":3,"sources":["../../src/store/indexeddb-local-backend.js"],"names":["VERSION","createDatabase","db","createObjectStore","keyPath","selectQuery","store","keyRange","resultMapper","query","openCursor","Promise","resolve","reject","results","onerror","event","Error","target","errorCode","onsuccess","cursor","result","push","continue","promiseifyTxn","txn","oncomplete","promiseifyRequest","req","LocalIndexedDBStoreBackend","indexedDBInterface","dbName","indexedDB","_dbName","_syncAccumulator","prototype","connect","open","onupgradeneeded","ev","oldVersion","then","onversionchange","close","_init","all","_loadAccountData","_loadSyncData","accountData","syncData","accumulate","next_batch","nextBatch","rooms","roomsData","account_data","events","clearDatabase","console","log","deleteDatabase","onblocked","warn","error","getSavedSync","copy","undefined","data","getJSON","deepCopy","setSyncData","syncToDatabase","userTuples","_persistUserPresenceEvents","_persistAccountData","_persistSyncData","try","transaction","objectStore","put","clobber","i","length","tuples","tuple","userId","getUserPresenceEvents","value"],"mappings":"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","file":"indexeddb-local-backend.js","sourcesContent":["/*\nCopyright 2017 Vector Creations Ltd\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport q from \"q\";\nimport SyncAccumulator from \"../sync-accumulator\";\nimport utils from \"../utils\";\n\nconst VERSION = 1;\n\nfunction createDatabase(db) {\n    // Make user store, clobber based on user ID. (userId property of User objects)\n    db.createObjectStore(\"users\", { keyPath: [\"userId\"] });\n\n    // Make account data store, clobber based on event type.\n    // (event.type property of MatrixEvent objects)\n    db.createObjectStore(\"accountData\", { keyPath: [\"type\"] });\n\n    // Make /sync store (sync tokens, room data, etc), always clobber (const key).\n    db.createObjectStore(\"sync\", { keyPath: [\"clobber\"] });\n}\n\n/**\n * Helper method to collect results from a Cursor and promiseify it.\n * @param {ObjectStore|Index} store The store to perform openCursor on.\n * @param {IDBKeyRange=} keyRange Optional key range to apply on the cursor.\n * @param {Function} resultMapper A function which is repeatedly called with a\n * Cursor.\n * Return the data you want to keep.\n * @return {Promise<T[]>} Resolves to an array of whatever you returned from\n * resultMapper.\n */\nfunction selectQuery(store, keyRange, resultMapper) {\n    const query = store.openCursor(keyRange);\n    return q.Promise((resolve, reject) => { /*eslint new-cap: 0*/\n        const results = [];\n        query.onerror = (event) => {\n            reject(new Error(\"Query failed: \" + event.target.errorCode));\n        };\n        // collect results\n        query.onsuccess = (event) => {\n            const cursor = event.target.result;\n            if (!cursor) {\n                resolve(results);\n                return; // end of results\n            }\n            results.push(resultMapper(cursor));\n            cursor.continue();\n        };\n    });\n}\n\nfunction promiseifyTxn(txn) {\n    return new q.Promise((resolve, reject) => {\n        txn.oncomplete = function(event) {\n            resolve(event);\n        };\n        txn.onerror = function(event) {\n            reject(event);\n        };\n    });\n}\n\nfunction promiseifyRequest(req) {\n    return new q.Promise((resolve, reject) => {\n        req.onsuccess = function(event) {\n            resolve(event);\n        };\n        req.onerror = function(event) {\n            reject(event);\n        };\n    });\n}\n\n/**\n * Does the actual reading from and writing to the indexeddb\n *\n * Construct a new Indexed Database store backend. This requires a call to\n * <code>connect()</code> before this store can be used.\n * @constructor\n * @param {Object} indexedDBInterface The Indexed DB interface e.g\n * <code>window.indexedDB</code>\n * @param {string=} dbName Optional database name. The same name must be used\n * to open the same database.\n */\nconst LocalIndexedDBStoreBackend = function LocalIndexedDBStoreBackend(\n    indexedDBInterface, dbName,\n) {\n    this.indexedDB = indexedDBInterface;\n    this._dbName = \"matrix-js-sdk:\" + (dbName || \"default\");\n    this.db = null;\n    this._syncAccumulator = new SyncAccumulator();\n};\n\n\nLocalIndexedDBStoreBackend.prototype = {\n    /**\n     * Attempt to connect to the database. This can fail if the user does not\n     * grant permission.\n     * @return {Promise} Resolves if successfully connected.\n     */\n    connect: function() {\n        if (this.db) {\n            return q();\n        }\n        const req = this.indexedDB.open(this._dbName, VERSION);\n        req.onupgradeneeded = (ev) => {\n            const db = ev.target.result;\n            const oldVersion = ev.oldVersion;\n            if (oldVersion < 1) { // The database did not previously exist.\n                createDatabase(db);\n            }\n            // Expand as needed.\n        };\n\n        return promiseifyRequest(req).then((ev) => {\n            this.db = ev.target.result;\n\n            // add a poorly-named listener for when deleteDatabase is called\n            // so we can close our db connections.\n            this.db.onversionchange = () => {\n                this.db.close();\n            };\n\n            return this._init();\n        });\n    },\n\n    /**\n     * Having connected, load initial data from the database and prepare for use\n     * @return {Promise} Resolves on success\n     */\n    _init: function() {\n        return q.all([\n            this._loadAccountData(),\n            this._loadSyncData(),\n        ]).then(([accountData, syncData]) => {\n            this._syncAccumulator.accumulate({\n                next_batch: syncData.nextBatch,\n                rooms: syncData.roomsData,\n                account_data: {\n                    events: accountData,\n                },\n            });\n        });\n    },\n\n    /**\n     * Clear the entire database. This should be used when logging out of a client\n     * to prevent mixing data between accounts.\n     * @return {Promise} Resolved when the database is cleared.\n     */\n    clearDatabase: function() {\n        return new q.Promise((resolve, reject) => {\n            console.log(`Removing indexeddb instance: ${this._dbName}`);\n            const req = this.indexedDB.deleteDatabase(this._dbName);\n\n            req.onblocked = () => {\n                console.log(\n                    `can't yet delete indexeddb ${this._dbName}` +\n                    ` because it is open elsewhere`,\n                );\n            };\n\n            req.onerror = (ev) => {\n                // in firefox, with indexedDB disabled, this fails with a\n                // DOMError. We treat this as non-fatal, so that we can still\n                // use the app.\n                console.warn(\n                    `unable to delete js-sdk store indexeddb: ${ev.target.error}`,\n                );\n                resolve();\n            };\n\n            req.onsuccess = () => {\n                console.log(`Removed indexeddb instance: ${this._dbName}`);\n                resolve();\n            };\n        });\n    },\n\n    /**\n     * @param {boolean=} copy If false, the data returned is from internal\n     * buffers and must not be muated. Otherwise, a copy is made before\n     * returning such that the data can be safely mutated. Default: true.\n     *\n     * @return {Promise} Resolves with a sync response to restore the\n     * client state to where it was at the last save, or null if there\n     * is no saved sync data.\n     */\n    getSavedSync: function(copy) {\n        if (copy === undefined) copy = true;\n\n        const data = this._syncAccumulator.getJSON();\n        if (!data.nextBatch) return q(null);\n        if (copy) {\n            // We must deep copy the stored data so that the /sync processing code doesn't\n            // corrupt the internal state of the sync accumulator (it adds non-clonable keys)\n            return q(utils.deepCopy(data));\n        } else {\n            return q(data);\n        }\n    },\n\n    setSyncData: function(syncData) {\n        return q().then(() => {\n            this._syncAccumulator.accumulate(syncData);\n        });\n    },\n\n    syncToDatabase: function(userTuples) {\n        const syncData = this._syncAccumulator.getJSON();\n\n        return q.all([\n            this._persistUserPresenceEvents(userTuples),\n            this._persistAccountData(syncData.accountData),\n            this._persistSyncData(syncData.nextBatch, syncData.roomsData),\n        ]);\n    },\n\n    /**\n     * Persist rooms /sync data along with the next batch token.\n     * @param {string} nextBatch The next_batch /sync value.\n     * @param {Object} roomsData The 'rooms' /sync data from a SyncAccumulator\n     * @return {Promise} Resolves if the data was persisted.\n     */\n    _persistSyncData: function(nextBatch, roomsData) {\n        console.log(\"Persisting sync data up to \", nextBatch);\n        return q.try(() => {\n            const txn = this.db.transaction([\"sync\"], \"readwrite\");\n            const store = txn.objectStore(\"sync\");\n            store.put({\n                clobber: \"-\", // constant key so will always clobber\n                nextBatch: nextBatch,\n                roomsData: roomsData,\n            }); // put == UPSERT\n            return promiseifyTxn(txn);\n        });\n    },\n\n    /**\n     * Persist a list of account data events. Events with the same 'type' will\n     * be replaced.\n     * @param {Object[]} accountData An array of raw user-scoped account data events\n     * @return {Promise} Resolves if the events were persisted.\n     */\n    _persistAccountData: function(accountData) {\n        return q.try(() => {\n            const txn = this.db.transaction([\"accountData\"], \"readwrite\");\n            const store = txn.objectStore(\"accountData\");\n            for (let i = 0; i < accountData.length; i++) {\n                store.put(accountData[i]); // put == UPSERT\n            }\n            return promiseifyTxn(txn);\n        });\n    },\n\n    /**\n     * Persist a list of [user id, presence event] they are for.\n     * Users with the same 'userId' will be replaced.\n     * Presence events should be the event in its raw form (not the Event\n     * object)\n     * @param {Object[]} tuples An array of [userid, event] tuples\n     * @return {Promise} Resolves if the users were persisted.\n     */\n    _persistUserPresenceEvents: function(tuples) {\n        return q.try(() => {\n            const txn = this.db.transaction([\"users\"], \"readwrite\");\n            const store = txn.objectStore(\"users\");\n            for (const tuple of tuples) {\n                store.put({\n                    userId: tuple[0],\n                    event: tuple[1],\n                }); // put == UPSERT\n            }\n            return promiseifyTxn(txn);\n        });\n    },\n\n    /**\n     * Load all user presence events from the database. This is not cached.\n     * FIXME: It would probably be more sensible to store the events in the\n     * sync.\n     * @return {Promise<Object[]>} A list of presence events in their raw form.\n     */\n    getUserPresenceEvents: function() {\n        return q.try(() => {\n            const txn = this.db.transaction([\"users\"], \"readonly\");\n            const store = txn.objectStore(\"users\");\n            return selectQuery(store, undefined, (cursor) => {\n                return [cursor.value.userId, cursor.value.event];\n            });\n        });\n    },\n\n    /**\n     * Load all the account data events from the database. This is not cached.\n     * @return {Promise<Object[]>} A list of raw global account events.\n     */\n    _loadAccountData: function() {\n        return q.try(() => {\n            const txn = this.db.transaction([\"accountData\"], \"readonly\");\n            const store = txn.objectStore(\"accountData\");\n            return selectQuery(store, undefined, (cursor) => {\n                return cursor.value;\n            });\n        });\n    },\n\n    /**\n     * Load the sync data from the database.\n     * @return {Promise<Object>} An object with \"roomsData\" and \"nextBatch\" keys.\n     */\n    _loadSyncData: function() {\n        return q.try(() => {\n            const txn = this.db.transaction([\"sync\"], \"readonly\");\n            const store = txn.objectStore(\"sync\");\n            return selectQuery(store, undefined, (cursor) => {\n                return cursor.value;\n            }).then((results) => {\n                if (results.length > 1) {\n                    console.warn(\"loadSyncData: More than 1 sync row found.\");\n                }\n                return (results.length > 0 ? results[0] : {});\n            });\n        });\n    },\n};\n\nexport default LocalIndexedDBStoreBackend;\n"]}